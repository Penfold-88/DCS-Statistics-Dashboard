name: Cleanup Merged Branches

on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no deletions)'
        required: false
        default: 'false'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Cleanup merged branches
      env:
        DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
      run: |
        echo "🧹 Cleaning up merged branches..." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Fetch all branches
        git fetch --all --prune
        
        # Get list of merged branches (excluding main, master, dev, develop)
        MERGED_BRANCHES=$(git branch -r --merged origin/main | 
          grep -v -E '(main|master|dev|develop|HEAD)' | 
          sed 's/origin\///')
        
        if [ -z "$MERGED_BRANCHES" ]; then
          echo "✅ No merged branches to clean up!" >> $GITHUB_STEP_SUMMARY
          exit 0
        fi
        
        echo "### Found merged branches:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "$MERGED_BRANCHES" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        if [ "$DRY_RUN" == "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Dry run mode** - no branches were deleted" >> $GITHUB_STEP_SUMMARY
        else
          # Delete merged branches
          for branch in $MERGED_BRANCHES; do
            echo "Deleting branch: $branch"
            git push origin --delete "$branch" || echo "Failed to delete $branch"
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Branches deleted successfully!**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: List remaining branches
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Remaining branches:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        git branch -r | grep -v HEAD | sed 's/origin\///' >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY